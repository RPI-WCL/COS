module rpiwcl.cos.test.salsa.trapezoid2;

import java.io.*;
import java.util.*;
import org.ho.yaml.Yaml;
import rpiwcl.cos.test.salsa.trapezoid2.*;
import rpiwcl.cos.runtime.CosInterface;


behavior Trap {
    // disribution support
	String nameServer;

    long initialTime;

    // Trap parameters
    int a;
    int b;
    int numWorkers;
    int numTasks;

    // configuration
    ArrayList configs;
    
	void act( String args[] ) {
		if ( args.length != 4 ) {
			System.err.println ( "Usage: java Trap <a> <b> <nameServer> <runtimes.txt>" );
			return;
		}

        // parse input parameters
        a = Integer.parseInt( args[0] );
        b = Integer.parseInt( args[1] );
        nameServer = args[2];

        configs = new ArrayList();
		try {
			BufferedReader in = new BufferedReader( new FileReader( args[3] ) );
            String str = in.readLine();
            String[] splits = str.split( "," );
            numWorkers = Integer.parseInt( splits[0] );
            numTasks = Integer.parseInt( splits[1] );

            while ((str = in.readLine()) != null) {
                configs.add( str );
            }

			in.close(); 
		} catch ( IOException ex ) {
			System.err.println( "Error: Can't open the file " + args[3] + " for reading." );
		}

        startTrap();
	}

    void startTrap() {
        TrapFarmer farmer = new TrapFarmer() at (new UAN( "uan://" + nameServer + "/trap" ), null );
        farmer<-submitJob( a, b, numTasks, numWorkers, nameServer, configs )@currentContinuation;
    }
	
}
